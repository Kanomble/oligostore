{% extends "core/base.html" %}
{% block title %}Primer Binding Analysis{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-10">

  <h1 class="text-3xl font-bold mb-6">
    Primer binding analysis
  </h1>

  {% if not sequence_files %}
    <div class="alert alert-warning mb-6">
      No sequence files available.
      <a href="{% url 'sequencefile_upload' %}" class="link link-primary ml-1">
        Upload one first
      </a>
    </div>
  {% endif %}

  <form id="primer-binding-form" method="POST" class="space-y-6">
    {% csrf_token %}

    <!-- Primer -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">Primer</span>
      </label>
      <select name="primer_id" class="select select-bordered" required>
        {% for primer in primers %}
          <option
            value="{{ primer.id }}"
            {% if primer.id|stringformat:"s" == preselected_primer %}selected{% endif %}
          >
            {{ primer.primer_name }} ({{ primer.sequence }})
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Sequence file -->
    <div class="form-control">
      <label class="label">
        <span class="label-text font-semibold">Sequence file</span>
      </label>
      <select
        name="sequence_file_id"
        class="select select-bordered"
        required
        {% if not sequence_files %}disabled{% endif %}
      >
        {% for sf in sequence_files %}
          <option
            value="{{ sf.id }}"
            {% if sf.id|stringformat:"s" == preselected_sequence_file %}selected{% endif %}
          >
            {{ sf.name }} ({{ sf.file_type|upper }})
          </option>
        {% endfor %}
      </select>

      <label class="label">
        <span class="label-text-alt">
          <a href="{% url 'sequencefile_upload' %}" class="link">
            Upload new sequence file
          </a>
        </span>
      </label>
    </div>

    <button
      class="btn btn-primary w-full"
      {% if not sequence_files %}disabled{% endif %}
    >
      Run binding analysis
    </button>

  </form>
 <div id="primer-binding-status" class="mt-6 hidden">
    <div class="alert alert-info">
      <span class="loading loading-spinner loading-md mr-2"></span>
      Running primer binding analysis. This may take a while for large genomes.
    </div>
  </div>

  <div id="primer-binding-error" class="mt-6 hidden">
    <div class="alert alert-error"></div>
  </div>

  <div id="primer-binding-results" class="mt-6 hidden">
    <h2 class="text-2xl font-semibold mb-4">Binding Results</h2>
    <div id="primer-binding-empty" class="alert alert-success hidden">
      No binding sites detected.
    </div>
    <div id="primer-binding-table" class="overflow-x-auto hidden">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Record</th>
            <th>Start</th>
            <th>End</th>
            <th>Strand</th>
            <th>Mismatches</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("primer-binding-form");
  const statusBox = document.getElementById("primer-binding-status");
  const errorBox = document.getElementById("primer-binding-error");
  const errorMessage = errorBox.querySelector(".alert");
  const resultsBox = document.getElementById("primer-binding-results");
  const emptyBox = document.getElementById("primer-binding-empty");
  const tableBox = document.getElementById("primer-binding-table");
  const tableBody = tableBox.querySelector("tbody");

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      return parts.pop().split(";").shift();
    }
    return "";
  }

  function resetUI() {
    statusBox.classList.add("hidden");
    errorBox.classList.add("hidden");
    resultsBox.classList.add("hidden");
    emptyBox.classList.add("hidden");
    tableBox.classList.add("hidden");
    tableBody.innerHTML = "";
  }

  function showError(message) {
    errorMessage.textContent = message;
    errorBox.classList.remove("hidden");
  }

  async function pollStatus(taskId) {
    const response = await fetch(
      "{% url 'primer_binding_status' 'TASK_ID' %}".replace("TASK_ID", taskId),
      { headers: { "Accept": "application/json" } }
    );
    if (!response.ok) {
      throw new Error("Unable to retrieve task status.");
    }
    const data = await response.json();

    if (data.state === "SUCCESS") {
      statusBox.classList.add("hidden");
      resultsBox.classList.remove("hidden");
      const hits = data.result || [];
      if (hits.length === 0) {
        emptyBox.classList.remove("hidden");
        return;
      }
      tableBox.classList.remove("hidden");
      hits.forEach((hit) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${hit.record_id}</td>
          <td>${hit.start}</td>
          <td>${hit.end}</td>
          <td>${hit.strand}</td>
          <td>${hit.mismatches}</td>
        `;
        tableBody.appendChild(row);
      });
      return;
    }

    if (data.state === "FAILURE") {
      statusBox.classList.add("hidden");
      showError(data.error || "Task failed.");
      return;
    }

    setTimeout(() => pollStatus(taskId), 2000);
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    resetUI();

    const formData = new FormData(form);
    statusBox.classList.remove("hidden");

    try {
      const response = await fetch("{% url 'primer_binding_async' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: formData,
      });

      if (!response.ok) {
        statusBox.classList.add("hidden");
        showError("Unable to start async analysis.");
        return;
      }

      const data = await response.json();
      if (!data.task_id) {
        statusBox.classList.add("hidden");
        showError("Task ID missing from response.");
        return;
      }

      pollStatus(data.task_id);
    } catch (error) {
      statusBox.classList.add("hidden");
      showError(error.message || "Unexpected error.");
    }
  });
</script>
{% endblock %}
