{% extends "core/base.html" %}
{% block title %}Primer List{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">Primers</h1>

    <div class="flex flex-wrap gap-2 justify-end">
        <a href="{% url 'primer_create' %}" class="btn btn-primary">
            + Add Primer
        </a>
        <a href="{% url 'primer_import_excel' %}" class="btn btn-outline">
            Import from Excel
        </a>
    </div>

    <div class="flex flex-wrap gap-2 justify-end">
        <a href="{% url 'primerpair_create' %}" class="btn btn-primary">
            + Create Primer Pair
        </a>
        <a href="{% url 'primerpair_combined_create' %}" class="btn btn-primary">
            + Create Primer Pair (with new primers)
        </a>
    </div>
</div>
<form method="GET" class="flex flex-wrap gap-4 items-end mb-6">
    <div class="form-control">
        <label class="label">
            <span class="label-text font-semibold">Search</span>
        </label>
        <input
            type="text"
            name="q"
            value="{{ request.GET.q }}"
            placeholder="Search by name, sequence, creator..."
            class="input input-bordered"
        />
    </div>

    <div class="form-control">
        <label class="label">
            <span class="label-text font-semibold">Order by</span>
        </label>
        <select name="order" class="select select-bordered">
            <option value="created_desc" {% if request.GET.order == "created_desc" or not request.GET.order %}selected{% endif %}>Newest</option>
            <option value="created" {% if request.GET.order == "created" %}selected{% endif %}>Oldest</option>
            <option value="name" {% if request.GET.order == "name" %}selected{% endif %}>Name (A-Z)</option>
            <option value="name_desc" {% if request.GET.order == "name_desc" %}selected{% endif %}>Name (Z-A)</option>
            <option value="length_desc" {% if request.GET.order == "length_desc" %}selected{% endif %}>Length (High-Low)</option>
            <option value="length" {% if request.GET.order == "length" %}selected{% endif %}>Length (Low-High)</option>
            <option value="gc_desc" {% if request.GET.order == "gc_desc" %}selected{% endif %}>GC% (High-Low)</option>
            <option value="gc" {% if request.GET.order == "gc" %}selected{% endif %}>GC% (Low-High)</option>
            <option value="tm_desc" {% if request.GET.order == "tm_desc" %}selected{% endif %}>TM (High-Low)</option>
            <option value="tm" {% if request.GET.order == "tm" %}selected{% endif %}>TM (Low-High)</option>
        </select>
    </div>
    <div class="form-control">
        <label class="label">
            <span class="label-text font-semibold">Per page</span>
        </label>
        <select name="per_page" class="select select-bordered">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
    </div>
    <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-ghost" href="{% url 'primer_list' %}">Reset</a>
    </div>
</form>
{% if primers %}
<form method="POST" action="{% url 'download_selected_primers' %}">
    {% csrf_token %}
    <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
        <span class="text-sm opacity-70">Select primers to download or delete.</span>
        <div class="flex flex-wrap gap-2">
            <button type="submit" class="btn btn-outline btn-sm">
                Download selected (Excel)
            </button>
            <button
                type="submit"
                class="btn btn-error btn-sm"
                formaction="{% url 'delete_selected_primers' %}"
                onclick="return confirm('Delete selected primers?');"
            >
                Delete selected
            </button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
            <thead>
                <tr>
                    <th>
                        <label class="flex items-center gap-2">
                            <input id="select-all-primers" type="checkbox" class="checkbox checkbox-sm">
                            <span class="text-xs">All</span>
                        </label>
                    </th>
                    <th>Name</th>
                    <th>Sequence</th>
                    <th>5â€² Overhang</th>
                    <th>Restriction Sites</th>
                    <th>Length</th>
                    <th>GC Content</th>
                    <th>Temperature</th>
                    <th>Hairpin</th>
                    <th>Self Dimer</th>
                    <th>Creator</th>
                    <th>Created</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for primer in primers %}
                <tr>
                    <td>
                        <input
                            type="checkbox"
                            name="primer_ids"
                            value="{{ primer.id }}"
                            class="checkbox checkbox-sm primer-select"
                        >
                    </td>
                    <td class="font-semibold">{{ primer.primer_name }}</td>
                    <td class="truncate max-w-xs">{{ primer.sequence }}</td>
                    <td class="truncate max-w-xs">
                        {{ primer.overhang_sequence|default:"-" }}
                    </td>
                    <td class="truncate max-w-xs">
                        {{ primer.restriction_site_summary|default:"-" }}
                    </td>
                    <td>{{ primer.length }}</td>
                    <td>{{ primer.gc_content }}</td>
                    <td>{{ primer.tm }}</td>
                    <td>{{ primer.hairpin_dg }}</td>
                    <td>{{ primer.self_dimer_dg }}</td>
                    <td>{{ primer.creator }}</td>
                    <td>{{ primer.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a href="{% url 'primer_delete' primer.id %}"
                           class="btn btn-error btn-sm"
                           onclick="return confirm('Delete this primer?');">
                            Delete
                        </a>
                    </td>
                    <td>
                        <a
                          href="{% url 'primer_binding' %}?primer={{ primer.id }}"
                          class="btn btn-sm btn-outline"
                        >
                          Binding analysis
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
<script>
    const selectAllPrimers = document.getElementById("select-all-primers");
    const primerCheckboxes = document.querySelectorAll(".primer-select");

    if (selectAllPrimers) {
        selectAllPrimers.addEventListener("change", () => {
            primerCheckboxes.forEach((checkbox) => {
                checkbox.checked = selectAllPrimers.checked;
            });
        });
    }
</script>
{% include "core/pagination.html" %}
{% else %}
<p class="text-center opacity-60 mt-10">No primers yet.</p>
{% endif %}
{% endblock %}
