{% extends "core/base.html" %}
{% block title %}Primer List{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">Primer Pairs</h1>

</div>
<form method="GET" class="flex flex-wrap gap-4 items-end mb-6">
    <div class="form-control">
        <label class="label">
            <span class="label-text font-semibold">Search</span>
        </label>
        <input
            type="text"
            name="q"
            value="{{ request.GET.q }}"
            placeholder="Search by name or primer sequence..."
            class="input input-bordered"
        />
    </div>

    <div class="form-control">
        <label class="label">
            <span class="label-text font-semibold">Order by</span>
        </label>
        <select name="order" class="select select-bordered">
            <option value="name" {% if request.GET.order == "name" or not request.GET.order %}selected{% endif %}>Name (A-Z)</option>
            <option value="name_desc" {% if request.GET.order == "name_desc" %}selected{% endif %}>Name (Z-A)</option>
            <option value="forward_name" {% if request.GET.order == "forward_name" %}selected{% endif %}>Forward name (A-Z)</option>
            <option value="forward_name_desc" {% if request.GET.order == "forward_name_desc" %}selected{% endif %}>Forward name (Z-A)</option>
            <option value="reverse_name" {% if request.GET.order == "reverse_name" %}selected{% endif %}>Reverse name (A-Z)</option>
            <option value="reverse_name_desc" {% if request.GET.order == "reverse_name_desc" %}selected{% endif %}>Reverse name (Z-A)</option>
            <option value="forward_tm_desc" {% if request.GET.order == "forward_tm_desc" %}selected{% endif %}>Forward TM (High-Low)</option>
            <option value="forward_tm" {% if request.GET.order == "forward_tm" %}selected{% endif %}>Forward TM (Low-High)</option>
            <option value="reverse_tm_desc" {% if request.GET.order == "reverse_tm_desc" %}selected{% endif %}>Reverse TM (High-Low)</option>
            <option value="reverse_tm" {% if request.GET.order == "reverse_tm" %}selected{% endif %}>Reverse TM (Low-High)</option>
        </select>
    </div>

    <div class="flex gap-2">
        <button class="btn btn-primary" type="submit">Apply</button>
        <a class="btn btn-ghost" href="{% url 'primerpair_list' %}">Reset</a>
    </div>
</form>
{% if primer_pairs %}
<form method="POST" action="{% url 'download_selected_primerpairs' %}">
    {% csrf_token %}
    <div class="flex items-center justify-between mb-4">
        <span class="text-sm opacity-70">Select primer pairs to download.</span>
        <button type="submit" class="btn btn-outline btn-sm">
            Download selected (Excel)
        </button>
    </div>
    <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
            <thead>
                <tr>
                    <th>
                        <label class="flex items-center gap-2">
                            <input id="select-all-primerpairs" type="checkbox" class="checkbox checkbox-sm">
                            <span class="text-xs">All</span>
                        </label>
                    </th>
                    <th>Primer Pair ID</th>
                    <th>Forward Sequence</th>
                    <th>Forward TM</th>
                    <th>Reverse Sequence</th>
                    <th>Reverse TM</th>
                    <th>Analysis</th>
                    <th>Delete Primer Pair</th>
                </tr>
            </thead>
            <tbody>
                {% for pair in primer_pairs %}
                <tr>
                    <td>
                        <input
                            type="checkbox"
                            name="primerpair_ids"
                            value="{{ pair.id }}"
                            class="checkbox checkbox-sm primerpair-select"
                        >
                    </td>
                    <td class="font-semibold">{{ pair.name }}</td>
                    <td>{{ pair.forward_primer.sequence }}</td>
                    <td>{{ pair.forward_primer.tm }} </td>
                    <td>{{ pair.reverse_primer.sequence }} </td>
                    <td>{{ pair.reverse_primer.tm }}</td>
                    <td>
                        <button
                            type="button"
                            class="btn btn-info btn-sm analyze-primerpair-btn"
                            data-forward="{{ pair.forward_primer.sequence }}"
                            data-reverse="{{ pair.reverse_primer.sequence }}"
                            data-target="analysis-{{ pair.id }}"
                        >
                            Analyze
                        </button>
                    </td>
                    <td><a href="{% url 'primerpair_delete' pair.id %}"
                       class="btn btn-error btn-sm"
                       onclick="return confirm('Delete this primer pair?');">
                       Delete
                    </a></td>
                </tr>
                <tr id="analysis-{{ pair.id }}" class="hidden">
                    <td colspan="8">
                        <div class="analysis-content"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
<script>
    const selectAllPrimerPairs = document.getElementById("select-all-primerpairs");
    const primerPairCheckboxes = document.querySelectorAll(".primerpair-select");

    if (selectAllPrimerPairs) {
        selectAllPrimerPairs.addEventListener("change", () => {
            primerPairCheckboxes.forEach((checkbox) => {
                checkbox.checked = selectAllPrimerPairs.checked;
            });
        });
    }

    const analysisButtons = document.querySelectorAll(".analyze-primerpair-btn");
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

    analysisButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const fwd = button.dataset.forward || "";
            const rev = button.dataset.reverse || "";
            const targetId = button.dataset.target;
            const targetRow = document.getElementById(targetId);
            const content = targetRow?.querySelector(".analysis-content");

            if (!content || !csrfToken) {
                return;
            }

            targetRow.classList.remove("hidden");
            content.innerHTML = "<p class=\"text-sm opacity-70\">Analyzing primer compatibility...</p>";

            fetch("{% url 'analyze_primerpair' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    "forward_sequence": fwd,
                    "reverse_sequence": rev,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    content.innerHTML = `<p class="text-error">${data.error}</p>`;
                    return;
                }

                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="card bg-base-200 p-4">
                            <h3 class="font-bold text-lg mb-2">Forward Primer</h3>
                            <p><strong>Tm:</strong> ${data.forward.tm}</p>
                            <p><strong>GC:</strong> ${data.forward.gc}%</p>
                            <p><strong>Hairpin ΔG:</strong> ${data.forward.hairpin_dg}</p>
                            <p><strong>Self-Dimer ΔG:</strong> ${data.forward.self_dimer_dg}</p>
                        </div>

                        <div class="card bg-base-200 p-4">
                            <h3 class="font-bold text-lg mb-2">Reverse Primer</h3>
                            <p><strong>Tm:</strong> ${data.reverse.tm}</p>
                            <p><strong>GC:</strong> ${data.reverse.gc}%</p>
                            <p><strong>Hairpin ΔG:</strong> ${data.reverse.hairpin_dg}</p>
                            <p><strong>Self-Dimer ΔG:</strong> ${data.reverse.self_dimer_dg}</p>
                        </div>
                    </div>

                    <div class="card bg-base-300 p-4 mt-4">
                        <h3 class="font-bold text-lg mb-2">Hetero-Dimer (Forward ↔ Reverse)</h3>
                        <p><strong>ΔG:</strong> ${data.hetero_dimer_dg}</p>
                    </div>
                `;
            })
            .catch(() => {
                content.innerHTML = "<p class=\"text-error\">Analysis failed. Please try again.</p>";
            });
        });
    });
</script>
{% include "core/pagination.html" %}
{% else %}
<p class="text-center opacity-60 mt-10">No primer pairs yet.</p>
{% endif %}
{% endblock %}
